<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å‘¨æœ«å»å“ªå„¿ï½œå¹¿å·ï¼ˆä¸¤äººÂ·å…¬å…±äº¤é€šç‰ˆï¼‰</title>
  <style>
    :root { --bg:#0b0c10; --card:#14161c; --text:#e8e8ea; --muted:#a9abb3; --line:#252834; --chip:#1b1f2a; --good:#b6f3c5; }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      background:var(--bg); color:var(--text); }
    header{ padding:18px 16px 10px; position:sticky; top:0; background:linear-gradient(180deg, rgba(11,12,16,.98), rgba(11,12,16,.86)); backdrop-filter: blur(8px); border-bottom:1px solid var(--line); z-index:10;}
    h1{ margin:0 0 6px; font-size:18px; }
    .sub{ color:var(--muted); font-size:12px; line-height:1.45; }
    .wrap{ padding:12px 16px 24px; max-width:1100px; margin:0 auto; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:10px; }
    .panel{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    label{ font-size:12px; color:var(--muted); display:flex; flex-direction:column; gap:6px; }
    select,input[type="text"]{ background:#0f1117; border:1px solid var(--line); color:var(--text);
      border-radius:10px; padding:8px 10px; min-width:150px; }
    input[type="checkbox"]{ transform: scale(1.05); }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .chip{ background:var(--chip); border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted); }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:12px; }
    .title{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .name{ font-weight:700; font-size:15px; line-height:1.25; }
    .score{ font-size:12px; color:var(--good); border:1px solid #2b6b3d; background:rgba(31, 90, 52, .25); padding:4px 8px; border-radius:999px; white-space:nowrap; }
    .meta{ margin-top:6px; color:var(--muted); font-size:12px; line-height:1.55; }
    .k{ color:#d7d7db; }
    .sep{ height:1px; background:var(--line); margin:10px 0; }
    .tiny{ font-size:11px; color:var(--muted); line-height:1.55; }
    .actions{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    button{ cursor:pointer; border-radius:12px; padding:8px 10px; border:1px solid var(--line); background:#0f1117; color:var(--text); font-size:12px; }
    button:hover{ border-color:#3a3f53; }
    .badge{ font-size:11px; border:1px solid var(--line); padding:3px 8px; border-radius:999px; color:var(--muted); }
    .warn{ color:#ffd7a8; border-color:#7b5a2a; background:rgba(120,85,30,.25); }
    .ok{ color:#b6f3c5; border-color:#2b6b3d; background:rgba(31, 90, 52, .22); }
    @media(min-width:920px){ .grid{ grid-template-columns: 420px 1fr; } }
  </style>
</head>
<body>
<header>
  <h1>å‘¨æœ«å»å“ªå„¿ï½œå¹¿å·ï¼ˆä¸¤äººÂ·å…¬å…±äº¤é€š/æ‰“è½¦ç‰ˆï¼‰</h1>
  <div class="sub">
    é•¿æœŸä½¿ç”¨ç‰ˆï¼šå°‘â€œæ‹ç…§æ‰“å¡â€ï¼Œæ›´åæ•£æ­¥/è½»å¾’æ­¥/å±•é¦†/å¬æ¼”å‡ºã€‚æ”¯æŒå­£èŠ‚ã€å¤©æ°”æ•æ„Ÿåº¦ã€äººæµ/èšŠè™«/è¡¥ç»™/ç…§æ˜/é¢„çº¦ç­‰ç»´åº¦ã€‚
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <div class="panel">
      <div class="row">
        <label>
          å‡ºå‘åœ°ï¼ˆå¯é€‰ï¼‰
          <input id="origin" type="text" placeholder="å¦‚ï¼šèå²—/é¦™é›ª/ç§‘å­¦åŸï¼ˆä»…ç”¨äºæç¤ºï¼‰" />
        </label>

        <label>
          å•ç¨‹æ—¶é—´é¢„ç®—
          <select id="timeBudget">
            <option value="30">â‰¤ 30 åˆ†é’Ÿ</option>
            <option value="45" selected>â‰¤ 45 åˆ†é’Ÿ</option>
            <option value="60">â‰¤ 60 åˆ†é’Ÿ</option>
            <option value="90">â‰¤ 90 åˆ†é’Ÿ</option>
            <option value="120">â‰¤ 120 åˆ†é’Ÿ</option>
          </select>
        </label>

        <label>
          å¼ºåº¦
          <select id="intensity">
            <option value="low">ä½ï¼ˆæ•£æ­¥/å¹³è·¯ï¼‰</option>
            <option value="mid" selected>ä¸­ï¼ˆè½»å¾’æ­¥/ç¼“å¡ï¼‰</option>
            <option value="high">é«˜ï¼ˆçˆ¬å±±/æ‹‰ç»ƒï¼‰</option>
          </select>
        </label>

        <label>
          å‡ºè¡Œæ–¹å¼åå¥½
          <select id="transitPref">
            <option value="easy" selected>çœå¿ƒä¼˜å…ˆï¼ˆå°‘æ¢ä¹˜ï¼‰</option>
            <option value="balanced">å¹³è¡¡</option>
            <option value="hard">ä¸ä»‹æ„æ¢ä¹˜</option>
          </select>
        </label>

        <label>
          é¢„ç®—ï¼ˆä¸¤äººï¼‰
          <select id="budget">
            <option value="low" selected>ä½ï¼ˆ0-60ï¼‰</option>
            <option value="mid">ä¸­ï¼ˆ60-160ï¼‰</option>
            <option value="high">é«˜ï¼ˆ160+ï¼‰</option>
          </select>
        </label>

        <label>
          å­£èŠ‚
          <select id="season">
            <option value="any" selected>ä¸æŒ‡å®š</option>
            <option value="spring">æ˜¥ï¼ˆçœ‹èŠ±/æœ€èˆ’é€‚ï¼‰</option>
            <option value="summer">å¤ï¼ˆé¿æ™’/é¿é—·ï¼‰</option>
            <option value="autumn">ç§‹ï¼ˆæœ€é€‚åˆé•¿èµ°ï¼‰</option>
            <option value="winter">å†¬ï¼ˆæ›´é€‚åˆæˆ·å¤–ï¼‰</option>
          </select>
        </label>

        <label>
          å¤©æ°”
          <select id="weather">
            <option value="any" selected>ä¸ç¡®å®š</option>
            <option value="sun">æ™´/çƒ­</option>
            <option value="rain">é›¨å¤©</option>
            <option value="cold">é™æ¸©/å¤§é£</option>
          </select>
        </label>
      </div>

      <label style="flex-direction:row; align-items:center; gap:8px;">
  <input id="hideVisited" type="checkbox" checked />
  <span>éšè—å·²å»è¿‡</span>
</label>

<label>
  å·²å»è¿‡é™æƒ
  <select id="visitedPenalty">
    <option value="soft">å¼±</option>
    <option value="mid" selected>ä¸­</option>
    <option value="hard">å¼º</option>
  </select>
</label>

      

      
      <div class="sep"></div>

      <div class="row">
        <label style="flex-direction:row; align-items:center; gap:8px;">
          <input id="avoidCrowd" type="checkbox" checked />
          <span>å°½é‡é¿å¼€äººæŒ¤äºº</span>
        </label>

        <label style="flex-direction:row; align-items:center; gap:8px;">
          <input id="avoidCheckin" type="checkbox" checked />
          <span>é™æƒç½‘çº¢æ‰“å¡å±æ€§</span>
        </label>

        <label style="flex-direction:row; align-items:center; gap:8px;">
          <input id="preferIndoorOnHot" type="checkbox" checked />
          <span>é—·çƒ­/æš´æ™’åå®¤å†…</span>
        </label>

        <label style="flex-direction:row; align-items:center; gap:8px;">
          <input id="careMosquito" type="checkbox" />
          <span>å¾ˆæ€•èšŠè™«ï¼ˆæ˜¥å¤ï¼‰</span>
        </label>

        <label style="flex-direction:row; align-items:center; gap:8px;">
          <input id="careToilet" type="checkbox" checked />
          <span>é‡è§†å•æ‰€/è¡¥ç»™</span>
        </label>

        <label style="flex-direction:row; align-items:center; gap:8px;">
          <input id="careLighting" type="checkbox" checked />
          <span>é‡è§†å‚æ™šç…§æ˜/å®‰å…¨</span>
        </label>

        <label style="flex-direction:row; align-items:center; gap:8px;">
          <input id="avoidReservation" type="checkbox" />
          <span>å°½é‡ä¸é¢„çº¦</span>
        </label>
      </div>

      <div class="sep"></div>
      <div class="tiny" id="dataStatus">æ•°æ®ï¼šåŠ è½½ä¸­â€¦ï¼ˆåœ°ç‚¹åº“å†…ç½® + å¯è‡ªåŠ¨æ‹‰å–çº¿ä¸Šæ´»åŠ¨åº“ï¼‰</div>

      <div class="actions" style="margin-top:12px;">
        <button id="btnReset">é‡ç½®</button>
        <button id="btnSort">é‡æ–°æ’åº</button>
        <button id="btnExport">å¤åˆ¶ Top5 ç»™å¯¹è±¡</button>
      </div>
    </div>

    <div>
      <div class="panel">
        <div class="k">ä»Šæ—¥æ¨èï¼ˆç»¼åˆåœ°ç‚¹ + æœ¬å‘¨æ´»åŠ¨ï¼‰</div>
        <div class="chips" id="activeChips"></div>
      </div>
      <div style="height:10px"></div>
      <div id="list" style="display:grid; gap:10px;"></div>
    </div>
  </div>
</div>

<script>
/**
 * çº¯è‡ªåŠ¨æ›´æ–°ï¼šæŠŠ DATA_URL æ¢æˆä½ è‡ªå·±çš„ data.json åœ°å€ï¼ˆGitHub Pages / ä»»ä½•é™æ€ç«™ï¼‰
 * data.json çš„ schemaï¼šè§ buildItem() æ³¨é‡Š
 */
const DATA_URL = new URL("./data.json", window.location.href).toString(); // ä¾‹å¦‚ï¼šhttps://<ä½ çš„åŸŸå>/data.json ï¼ˆç•™ç©ºè¡¨ç¤ºåªç”¨å†…ç½®æ•°æ®ï¼‰

/** å†…ç½®â€œé•¿æœŸåœ°ç‚¹åº“â€ï¼ˆåä½“éªŒï¼Œä¸é æ‰“å¡ï¼‰ */
const builtinPlaces = [
  {
    type: "place",
    name: "ç§‘å­¦åŸÂ·ç‰æ ‘å…¬å›­â€”ä½“è‚²å…¬å›­â€”å°–å³°å²­ï¼ˆè¿èµ°ï¼‰",
    area: "é»„åŸ”Â·ç§‘å­¦åŸ",
    tags: ["æ•£æ­¥", "æ—è«", "è¿èµ°è·¯çº¿", "èŠå¤©å‹å¥½", "åŠæ—¥"],
    transitEase: 4, // 1-5
    transferComplexity: 2, // 1(ç›´è¾¾)-5(éº»çƒ¦)
    timeMin: 25,
    intensity: "mid",
    cost: "low",
    crowdRisk: 2,
    checkin: 1,
    weatherFit: { rain:false, sun:true, cold:true },
    seasonFit: { spring:true, summer:true, autumn:true, winter:true },
    mosquito: 3, // 1-5
    toiletSupply: 4, // 1-5
    lighting: 4, // 1-5
    reservation: "no",
    openHoursHint: "å…¬å›­ç±»ä¸€èˆ¬å…¨å¤©å¼€æ”¾ï¼ˆä»¥ç°åœºä¸ºå‡†ï¼‰",
    notes: "ä¸‰å›­ç›¸è¿ï¼Œèµ°èµ·æ¥åƒåŸå¸‚é‡Œçš„è½»å¾’æ­¥ï¼ŒèŠå¤©èµ°è·¯å¾ˆèˆ’æœã€‚",
    source: "builtin"
  },
  {
    type: "place",
    name: "å¤©é¹¿æ¹–æ£®æ—å…¬å›­ï¼ˆæ´—è‚ºè½»å¾’æ­¥ï¼‰",
    area: "é»„åŸ”",
    tags: ["è½»å¾’æ­¥", "æ¹–æ™¯", "ç©ºæ°”å¥½", "åŠæ—¥/å…¨å¤©"],
    transitEase: 3, transferComplexity: 3, timeMin: 45, intensity:"mid", cost:"low",
    crowdRisk: 3, checkin:2,
    weatherFit:{ rain:false, sun:true, cold:true },
    seasonFit:{ spring:true, summer:true, autumn:true, winter:true },
    mosquito: 4, toiletSupply: 3, lighting: 3,
    reservation:"no",
    openHoursHint:"å…¬å›­ç±»ä»¥ç°åœºä¸ºå‡†",
    notes:"é€‚åˆæƒ³å‡ºæ±—ä½†ä¸æ‹‰ç»ƒçš„ä¸€å¤©ï¼›æ˜¥å­£èŠ±æœŸ/èŠ‚å‡æ—¥äººä¼šæ›´å¤šã€‚",
    source:"builtin"
  },
  {
    type: "place",
    name: "å¹¿ä¸œçœå‡‰èŒ¶åšç‰©é¦†ï¼ˆé›¨å¤©å¤‡é€‰ï¼‰",
    area: "é»„åŸ”Â·ç§‘å­¦åŸ/é‡‘å³°é™„è¿‘",
    tags: ["å®¤å†…", "æ–‡åŒ–", "é›¨å¤©", "çœå¿ƒ", "åŠæ—¥"],
    transitEase: 5, transferComplexity: 2, timeMin: 35, intensity:"low", cost:"low",
    crowdRisk: 2, checkin:2,
    weatherFit:{ rain:true, sun:true, cold:true },
    seasonFit:{ spring:true, summer:true, autumn:true, winter:true },
    mosquito: 1, toiletSupply: 4, lighting: 5,
    reservation:"maybe",
    openHoursHint:"ä»¥å®˜æ–¹å…¬å‘Š/ç°åœºä¸ºå‡†",
    notes:"é›¨å¤©/æš´æ™’å¤©å¾ˆå‹å¥½ï¼šçœ‹å±•+è½»æ¾èµ°åŠ¨ï¼Œä¸ä¾èµ–æ‹ç…§ã€‚",
    source:"builtin"
  },
  {
    type: "place",
    name: "å¹¿å·æµ·äº‹åšç‰©é¦†ï¼ˆé›¨å¤©æ…¢é€›ï¼‰",
    area: "é»„åŸ”ï¼ˆå—æµ·ç¥åº™é™„è¿‘ï¼‰",
    tags: ["å®¤å†…", "å±•é¦†", "é›¨å¤©", "æ…¢é€›", "åŠæ—¥"],
    transitEase: 4, transferComplexity: 3, timeMin: 70, intensity:"low", cost:"low",
    crowdRisk: 2, checkin:1,
    weatherFit:{ rain:true, sun:true, cold:true },
    seasonFit:{ spring:true, summer:true, autumn:true, winter:true },
    mosquito: 1, toiletSupply: 4, lighting: 5,
    reservation:"maybe",
    openHoursHint:"ä»¥å®˜æ–¹å…¬å‘Š/ç°åœºä¸ºå‡†",
    notes:"èŠ‚å¥èˆ’é€‚ï¼Œé€‚åˆä¸æƒ³åšæ”»ç•¥çš„é›¨å¤©å‘¨å…­ã€‚",
    source:"builtin"
  }
];

/**
 * data.json åˆå¹¶è¿›æ¥çš„æ¡ç›® schemaï¼ˆä½ çº¯è‡ªåŠ¨æ›´æ–°æ—¶ç”Ÿæˆï¼‰ï¼š
 * {
 *   "items":[
 *     {"type":"event","name":"â€¦","area":"â€¦","date":"2026-01-10","timeHint":"19:30-21:00","cost":"mid","reservation":"yes/no/maybe",
 *      "tags":["å±•è§ˆ/æ¼”å‡º/æ´»åŠ¨"],"transitEase":3,"transferComplexity":3,"timeMin":70,"intensity":"low",
 *      "crowdRisk":3,"checkin":2,"weatherFit":{"rain":true,"sun":true,"cold":true},
 *      "seasonFit":{"spring":true,"summer":true,"autumn":true,"winter":true},
 *      "mosquito":1,"toiletSupply":3,"lighting":4,"openHoursHint":"â€¦","notes":"â€¦","link":"https://â€¦","source":"wglj/douban/â€¦"}
 *   ],
 *   "meta":{"generatedAt":"2026-01-06T10:00:00+08:00","sources":["â€¦"]}
 * }
 */
let onlineItems = [];
// ===== å»è¿‡å¤¹å­ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰=====
const VISITED_KEY = "gz_weekend_visited_v1";

function loadVisited() {
  try {
    const raw = localStorage.getItem(VISITED_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return new Set(Array.isArray(arr) ? arr : []);
  } catch {
    return new Set();
  }
}

function saveVisited(setObj) {
  const arr = Array.from(setObj);
  localStorage.setItem(VISITED_KEY, JSON.stringify(arr));
}

function itemKey(it) {
  // ç”¨ link ä¼˜å…ˆï¼Œå…¶æ¬¡ name+areaï¼›ä¿è¯ç›¸å¯¹ç¨³å®š
  if (it.link) return `link:${it.link}`;
  return `na:${it.name || ""}@@${it.area || ""}`;
}

function isSeasonalSpecial(it) {
  const tags = it.tags || [];
  const text = (it.name || "") + " " + (it.notes || "") + " " + tags.join(" ");
  const specialWords = ["èŠ±æœŸ", "èµèŠ±", "çœ‹èŠ±", "é™å®š", "å­£èŠ‚é™å®š", "å¤œæ¸¸", "ç¯ä¼š", "èŠ‚æ—¥", "æ¨±èŠ±", "æ¢…èŠ±", "è·èŠ±", "çº¢å¶", "è‰è“", "ç¦¾é›€èŠ±"];
  return specialWords.some(w => text.includes(w));
}

let visitedSet = loadVisited();

function markVisited(it) {
  visitedSet.add(itemKey(it));
  saveVisited(visitedSet);
  render();
}

function unmarkVisited(it) {
  visitedSet.delete(itemKey(it));
  saveVisited(visitedSet);
  render();
}

function isVisited(it) {
  return visitedSet.has(itemKey(it));
}

function findItemByKey(k) {
  const all = [...builtinPlaces, ...onlineItems];
  for (const it of all) {
    if (itemKey(it) === k) return it;
  }
  return null;
}

function markVisitedByKey(k) {
  const it = findItemByKey(k);
  if (!it) return;
  markVisited(it);
}

function unmarkVisitedByKey(k) {
  const it = findItemByKey(k);
  if (!it) return;
  unmarkVisited(it);
}

let dataMeta = null;

function getPrefs(){
  return {
    origin: document.getElementById("origin").value.trim(),
    timeBudget: Number(document.getElementById("timeBudget").value),
    intensity: document.getElementById("intensity").value,
    transitPref: document.getElementById("transitPref").value,
    budget: document.getElementById("budget").value,
    season: document.getElementById("season").value,
    weather: document.getElementById("weather").value,
    avoidCrowd: document.getElementById("avoidCrowd").checked,
    avoidCheckin: document.getElementById("avoidCheckin").checked,
    preferIndoorOnHot: document.getElementById("preferIndoorOnHot").checked,
    careMosquito: document.getElementById("careMosquito").checked,
    careToilet: document.getElementById("careToilet").checked,
    careLighting: document.getElementById("careLighting").checked,
    avoidReservation: document.getElementById("avoidReservation").checked,
    hideVisited: document.getElementById("hideVisited").checked,
    visitedPenalty: document.getElementById("visitedPenalty").value,
 
  };
}

const rankCost = { low:1, mid:2, high:3 };

function seasonKeyToFit(season){
  if(season==="spring") return "spring";
  if(season==="summer") return "summer";
  if(season==="autumn") return "autumn";
  if(season==="winter") return "winter";
  return "any";
}

function scoreItem(it, p){
  let score = 100;

  // æ—¶é—´é¢„ç®—ï¼šè¶…è¿‡åˆ™æ‰£åˆ†
  if ((it.timeMin||999) > p.timeBudget) score -= ((it.timeMin - p.timeBudget) * 2.0);

  // å¼ºåº¦åŒ¹é…
  if (p.intensity === "low" && it.intensity === "high") score -= 26;
  if (p.intensity === "low" && it.intensity === "mid") score -= 10;
  if (p.intensity === "high" && it.intensity === "low") score -= 10;

  // å‡ºè¡Œçœå¿ƒï¼šæ¢ä¹˜å¤æ‚åº¦ + transitEase
  const tp = p.transitPref;
  if (tp === "easy"){
    score += ((it.transitEase||3) - 3) * 7;
    score -= ((it.transferComplexity||3) - 2) * 6;
  } else if (tp === "balanced"){
    score += ((it.transitEase||3) - 3) * 4;
    score -= ((it.transferComplexity||3) - 3) * 3;
  } else { // hard
    score += ((it.transitEase||3) - 3) * 2;
    score -= ((it.transferComplexity||3) - 3) * 1;
  }

  // é¢„ç®—
  if (rankCost[it.cost||"low"] > rankCost[p.budget]) score -= 18;

  // å­£èŠ‚
  if (p.season !== "any"){
    const key = seasonKeyToFit(p.season);
    if (it.seasonFit && it.seasonFit[key] === false) score -= 18;
    if (it.tags && key==="spring" && it.tags.includes("çœ‹èŠ±")) score += 10; // æ˜¥å­£çœ‹èŠ±åŠ åˆ†
  }

  // å¤©æ°”
  if (p.weather !== "any"){
    const ok = it.weatherFit ? it.weatherFit[p.weather] : true;
    if (!ok) score -= 28;
    if (p.weather === "sun" && p.preferIndoorOnHot && it.tags && it.tags.includes("å®¤å†…")) score += 6;
  }

  // é¿äºº
  if (p.avoidCrowd) score -= ((it.crowdRisk||3) - 2) * 7;

  // é¿æ‰“å¡
  if (p.avoidCheckin) score -= ((it.checkin||2) - 1) * 6;

  // èšŠè™«ï¼ˆæ˜¥å¤æ›´æ•æ„Ÿï¼‰
  if (p.careMosquito){
    score -= ((it.mosquito||3) - 2) * 6;
    if (p.season === "summer") score -= ((it.mosquito||3) - 2) * 2;
  }

  // å•æ‰€/è¡¥ç»™
  if (p.careToilet) score += ((it.toiletSupply||3) - 3) * 4;

  // ç…§æ˜/å®‰å…¨ï¼ˆå‚æ™šï¼‰
  if (p.careLighting) score += ((it.lighting||3) - 3) * 4;

  // é¢„çº¦ï¼šä¸æƒ³é¢„çº¦åˆ™æ‰£
  if (p.avoidReservation){
    if (it.reservation === "yes") score -= 16;
    if (it.reservation === "maybe") score -= 8;
  }

  // æ´»åŠ¨æ¡ç›®å°åŠ æˆï¼šæ›´â€œå½“å‘¨å¯ç”¨â€
  if (it.type === "event") score += 6;
  // å·²å»è¿‡ï¼šé™æƒ/éšè—ï¼ˆä½†å­£èŠ‚é™å®š/ç‰¹æ®Šæ™¯è‰²ä¸å¼ºå‹ï¼‰
  const visited = isVisited(it);
  const special = isSeasonalSpecial(it);

  if (visited) {
    if (p.hideVisited && !special) {
      score -= 9999; // ç›´æ¥æ²‰åº•ï¼Œç›¸å½“äºéšè—
    } else {
      // ä¸éšè—åˆ™é™æƒï¼ŒåŠ›åº¦å¯è°ƒï¼›special çš„é™æƒå‡åŠ
      const basePenalty = p.visitedPenalty === "soft" ? 12 : (p.visitedPenalty === "mid" ? 25 : 45);
      score -= special ? Math.round(basePenalty * 0.5) : basePenalty;
      if (special) score += 6; // è¿‘æœŸç‰¹æ®Šæ™¯è‰²ç»™ä¸€ç‚¹è¡¥å¿
    }
  }

  return Math.round(score);
}

function badges(it){
  const arr = [];
  if (it.type === "event") arr.push(`<span class="badge ok">æœ¬å‘¨æ´»åŠ¨</span>`);
  if (it.reservation === "yes") arr.push(`<span class="badge warn">éœ€é¢„çº¦</span>`);
  if (it.crowdRisk >= 4) arr.push(`<span class="badge warn">äººå¤šé£é™©</span>`);
  if (it.tags && it.tags.includes("å®¤å†…")) arr.push(`<span class="badge">å®¤å†…</span>`);
  if (it.intensity === "high") arr.push(`<span class="badge warn">å¼ºåº¦é«˜</span>`);
  return arr.join(" ");
}

function render(){
  const p = getPrefs();
  const chips = [];
  chips.push(`å•ç¨‹â‰¤${p.timeBudget}min`);
  chips.push(p.intensity==="low"?"ä½å¼ºåº¦":p.intensity==="mid"?"ä¸­å¼ºåº¦":"é«˜å¼ºåº¦");
  chips.push(p.transitPref==="easy"?"çœå¿ƒä¼˜å…ˆ":p.transitPref==="balanced"?"å¹³è¡¡":"ä¸ä»‹æ„æ¢ä¹˜");
  chips.push(p.season==="any"?"ä¸æŒ‡å®šå­£èŠ‚":p.season);
  chips.push(p.weather==="any"?"ä¸çœ‹å¤©æ°”":p.weather);
  if (p.avoidCrowd) chips.push("é¿äºº");
  if (p.avoidCheckin) chips.push("é¿æ‰“å¡");
  if (p.careMosquito) chips.push("æ€•èšŠè™«");
  if (p.avoidReservation) chips.push("ä¸æƒ³é¢„çº¦");
  document.getElementById("activeChips").innerHTML = chips.map(c=>`<span class="chip">${escapeHtml(c)}</span>`).join("");

  const all = [...builtinPlaces, ...onlineItems];
  const ranked = all.map(it=>({ ...it, _score: scoreItem(it,p)})).sort((a,b)=>b._score-a._score);

  const list = document.getElementById("list");
  list.innerHTML = ranked.map(it => `
    <div class="card">
      <div class="title">
        <div>
          <div class="name">${escapeHtml(it.name)}</div>
          <div class="meta">
            ğŸ“<span class="k">${escapeHtml(it.area||"å¹¿å·")}</span>
            Â· â± çº¦${it.timeMin ?? "?"}åˆ†é’Ÿå•ç¨‹
            Â· å¼ºåº¦ï¼š<span class="k">${labelIntensity(it.intensity)}</span>
            Â· ${badges(it)}
          </div>
        </div>
        <div class="score">åŒ¹é…åº¦ ${it._score}</div>
      </div>

      <div class="chips">${(it.tags||[]).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join("")}</div>

      ${it.date ? `<div class="meta"><span class="k">æ—¶é—´ï¼š</span>${escapeHtml(it.date)} ${escapeHtml(it.timeHint||"")}</div>` : ""}

      <div class="meta"><span class="k">å¼€æ”¾/é¢„çº¦ï¼š</span>${escapeHtml(it.openHoursHint||"ä»¥å®˜æ–¹å…¬å‘Š/ç°åœºä¸ºå‡†")}ï¼›é¢„çº¦ï¼š${escapeHtml(it.reservation||"unknown")}</div>

      <div class="meta"><span class="k">ä¸ºä»€ä¹ˆé€‚åˆï¼š</span>${escapeHtml(it.notes||"")}</div>

     <div class="actions">
  <button onclick="copyText('${escapeJs(composeShare(it))}')">å¤åˆ¶ç»™å¯¹è±¡</button>
  <button onclick="openMap('${escapeJs((it.name||'') + ' ' + (it.area||'å¹¿å·'))}')">æ‰“å¼€åœ°å›¾æœç´¢</button>
  ${it.link ? `<button onclick="window.open('${escapeJs(it.link)}','_blank')">æ‰“å¼€æ¥æº</button>` : ""}
  ${isVisited(it)
    ? `<button onclick='unmarkVisitedByKey(${JSON.stringify(itemKey(it))})'>â†©ï¸ å–æ¶ˆå»è¿‡</button>`
    : `<button onclick='markVisitedByKey(${JSON.stringify(itemKey(it))})'>âœ… æ ‡è®°å»è¿‡</button>`
  }
</div>


      <div class="tiny">æ¥æºï¼š${escapeHtml(it.source||"builtin")}</div>
    </div>
  `).join("");
}

function composeShare(it){
  const bits = [];
  bits.push(`ã€${it.type==="event"?"æœ¬å‘¨æ´»åŠ¨":"åœ°ç‚¹"}ã€‘${it.name}`);
  if (it.area) bits.push(`åœ°ç‚¹ï¼š${it.area}`);
  if (it.date) bits.push(`æ—¶é—´ï¼š${it.date} ${it.timeHint||""}`.trim());
  if (it.notes) bits.push(`ç†ç”±ï¼š${it.notes}`);
  if (it.openHoursHint) bits.push(`å¼€æ”¾/é¢„çº¦ï¼š${it.openHoursHint}ï¼ˆé¢„çº¦ï¼š${it.reservation||"unknown"}ï¼‰`);
  if (it.link) bits.push(`æ¥æºï¼š${it.link}`);
  return bits.join("\n");
}

function labelIntensity(x){ return x==="low"?"ä½":x==="mid"?"ä¸­":"é«˜"; }

function openMap(q){
  // ä½ å¯ä»¥æ”¹æˆé«˜å¾·/ç™¾åº¦ schemeï¼›æ­¤å¤„ç”¨æµè§ˆå™¨æœç´¢å…œåº•
  window.open("https://www.google.com/search?q=" + encodeURIComponent(q + " å¹¿å·"), "_blank");
}

function copyText(t){
  navigator.clipboard.writeText(t).then(()=>alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"));
}

function escapeHtml(str){
  return String(str ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function escapeJs(str){
  return String(str ?? "").replaceAll("\\","\\\\").replaceAll("'","\\'").replaceAll('"','\\"').replaceAll("\n"," ");
}

// ç»‘å®š
document.getElementById("btnSort").addEventListener("click", render);
document.querySelectorAll("select,input").forEach(el => el.addEventListener("change", render));

document.getElementById("btnReset").addEventListener("click", () => {
  document.getElementById("origin").value = "";
  document.getElementById("timeBudget").value = "45";
  document.getElementById("intensity").value = "mid";
  document.getElementById("transitPref").value = "easy";
  document.getElementById("budget").value = "low";
  document.getElementById("season").value = "any";
  document.getElementById("weather").value = "any";
  document.getElementById("avoidCrowd").checked = true;
  document.getElementById("avoidCheckin").checked = true;
  document.getElementById("preferIndoorOnHot").checked = true;
  document.getElementById("careMosquito").checked = false;
  document.getElementById("careToilet").checked = true;
  document.getElementById("careLighting").checked = true;
  document.getElementById("avoidReservation").checked = false;

  document.getElementById("hideVisited").checked = true;
  document.getElementById("visitedPenalty").value = "mid";

  render();
});

document.getElementById("btnExport").addEventListener("click", () => {
  const p = getPrefs();
  const all = [...builtinPlaces, ...onlineItems];
  const ranked = all.map(it=>({ ...it, _score: scoreItem(it,p)})).sort((a,b)=>b._score-a._score).slice(0,5);
  const text = ranked.map((it,i)=>`${i+1}. ${it.type==="event"?"[æ´»åŠ¨]":"[åœ°ç‚¹]"} ${it.name}ï¼ˆ${it.area||"å¹¿å·"}ï¼‰åŒ¹é…åº¦${it._score}`).join("\n");
  copyText("æœ¬å‘¨Top5ï¼š\n" + text);
});

// åŠ è½½çº¿ä¸Šæ•°æ®
async function loadOnline(){
  const el = document.getElementById("dataStatus");
  if(!DATA_URL){
    el.textContent = "æ•°æ®ï¼šä»…ä½¿ç”¨å†…ç½®åœ°ç‚¹åº“ï¼ˆå¦‚éœ€çº¯è‡ªåŠ¨æ›´æ–°ï¼šæŠŠ DATA_URL æ”¹æˆä½ çš„ data.json åœ°å€ï¼‰";
    return;
  }
  try{
    const r = await fetch(DATA_URL, { cache:"no-store" });
    if(!r.ok) throw new Error("HTTP " + r.status);
    const j = await r.json();
    onlineItems = Array.isArray(j.items) ? j.items : [];
    dataMeta = j.meta || null;
    el.textContent = `æ•°æ®ï¼šå·²åŠ è½½çº¿ä¸Šæ´»åŠ¨åº“ ${onlineItems.length} æ¡` + (dataMeta?.generatedAt ? `ï¼ˆæ›´æ–°äº ${dataMeta.generatedAt}ï¼‰` : "");
  }catch(e){
    el.textContent = "æ•°æ®ï¼šçº¿ä¸Šæ´»åŠ¨åº“åŠ è½½å¤±è´¥ï¼Œå·²å›é€€åˆ°å†…ç½®åœ°ç‚¹åº“ï¼ˆæ£€æŸ¥ DATA_URL æ˜¯å¦å¯è®¿é—®ï¼‰ã€‚";
    onlineItems = [];
    dataMeta = null;
  }
}

(async function init(){
  await loadOnline();
  render();
})();
</script>
</body>
</html>
